## Roadmap

### Этап 0. Базовая инфраструктура проекта
- **Инициализация репозитория**
  - Создать базовую структуру проекта (Python-пакет для приложения, директории `api`, `db`, `clients`, `tasks`, `core` и т.п.).
  - Настроить виртуальное окружение и зависимости (`FastAPI`, `SQLAlchemy` (async), `Alembic`, `Celery`, `aiohttp`, `psycopg2-binary`/`asyncpg` и др.).
  - Добавить базовые настройки форматирования/линтинга (по желанию).

- **Docker Compose (черновая версия)**
  - Описать сервисы: `app` (FastAPI), `db` (PostgreSQL), `broker` (например, Redis), `worker` (Celery worker), при необходимости `beat` (Celery beat / scheduler).
  - Обеспечить возможность локального запуска одной командой.

### Этап 1. Модель данных и миграции
- **Проектирование схемы БД**
  - Определить таблицу (например, `ticker_prices`): `id`, `ticker`, `price`, `timestamp` (UNIX), `created_at`.
  - Сразу продумать индексы по `ticker` и `timestamp`.

- **Alembic**
  - Настроить Alembic для работы с async SQLAlchemy.
  - Добавить первую миграцию с созданием таблиц.

### Этап 2. Клиент к Deribit
- **Инкапсулированный HTTP-клиент**
  - Реализовать клиент для Deribit в отдельном модуле/классе (например, `DeribitClient`).
  - Использовать асинхронный HTTP-клиент (изначально `aiohttp`).
  - Обеспечить конфигурируемость базового URL и таймаутов.

### Этап 3. Слой доступа к данным
- **ORM-модели и репозитории**
  - Описать ORM-модель цены тикера.
  - Реализовать репозиторий/DAO для:
    - сохранения цен,
    - выборки по тикеру,
    - выборки последней цены,
    - выборки по диапазону дат.

### Этап 4. Периодический сбор цен (Celery)
- **Celery конфигурация**
  - Выбрать брокер (на старте — Redis в Docker; в дизайн-доке описать альтернативы: RabbitMQ и др.).
  - Настроить Celery worker и, при необходимости, Celery beat для периодического запуска задач.

- **Фоновые задачи**
  - Задача получения цен с Deribit для `btc_usd` и `eth_usd` каждую минуту.
  - Обработка ошибок (логирование, повторы по необходимости).
  - Сохранение данных в PostgreSQL через слой репозиториев.

### Этап 5. Внешнее API (FastAPI)
- **Структура API**
  - Ввести версионирование: базовый префикс, например `/api/v1`.
  - Реализовать эндпоинты (все GET с обязательным `ticker`):
    - Получение всех сохранённых данных по валюте.
    - Получение последней цены валюты.
    - Получение цен с фильтром по дате (диапазон дат или отдельные параметры).

- **Документация**
  - Описать схемы запросов/ответов через Pydantic-модели.
  - Убедиться, что OpenAPI, генерируемый FastAPI, корректен и покрывает все методы.

### Этап 6. Тестирование
- **Unit-тесты (необязательное требование ТЗ, но желательно)**
  - Тесты для:
    - клиента Deribit (с моками HTTP-клиента),
    - репозиториев,
    - основных API-эндпоинтов.
  - При желании — базовые интеграционные тесты с тестовой БД.

### Этап 7. Docker Compose и локальный запуск
- **Уточнение Docker-конфигурации**
  - Доработать Dockerfile для приложения (оптимизация размера образа, зависимостей).
  - Обновить `docker-compose.yml`:
    - правильная последовательность старта сервисов,
    - вольюмы для БД,
    - переменные окружения (например, для подключения к БД и брокеру).

- **Документация по развёртыванию**
  - Подробно описать сценарии:
    - локальный запуск через Docker Compose

### Этап 8. Выход «на полную мощность» (за рамками учебного прототипа)
- **Надёжность и масштабируемость**
  - Пересмотреть выбор брокера:
    - Рассмотреть переход с Redis на RabbitMQ для прод-окружений (надёжные очереди, подтверждения, гибкая маршрутизация).
  - Продумать стратегию ретенции данных (очистка старых записей, архивирование).
  - Добавить дополнительные индексы/оптимизации запросов при росте объёма данных.

- **Наблюдаемость и эксплуатация**
  - Добавить структурированное логирование и метрики (задержки запросов, частота ошибок, лаг по сбору котировок).
  - Подготовить базовый CI/CD (GitLab CI) для автоматической проверки и сборки образов.

- **Расширяемость**
  - Учесть возможность добавления новых тикеров и/или бирж без серьёзной переработки архитектуры.
  - Вынести параметры (список тикеров, частота опроса) в конфигурацию.


